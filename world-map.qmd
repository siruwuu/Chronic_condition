---
title: "å…¨çƒæ…¢æ€§ç—…æŒ‡æ ‡åœ°å›¾"
format:
  html:
    toc: true
    code-fold: false
jupyter: python3
---

---
title: "å…¨çƒæ…¢æ€§ç—…æŒ‡æ ‡åœ°å›¾"
format:
  html:
    toc: true
    code-fold: false
jupyter: python3
---

## ğŸ—ºï¸ å…¨çƒå¥åº·æŒ‡æ ‡åˆ†å¸ƒåœ°å›¾

æœ¬å›¾å±•ç¤ºäº†å„å›½åœ¨ç‰¹å®šå¹´ä»½ä¸æ€§åˆ«ä¸‹çš„å¥åº·æŒ‡æ ‡ï¼ˆBMIã€ç³–å°¿ç—…ã€é«˜è¡€å‹ç­‰ï¼‰åˆ†å¸ƒæƒ…å†µã€‚

```{python}
import pandas as pd
import altair as alt
import json

# è¯»å–æ•°æ®
data = pd.read_csv("data/processed-data/who_pivoted_data_with_classes.csv")

# åœ°å›¾æ•°æ®ï¼ˆGeoJSONï¼‰
with open("data/maps/world_countries.json", "r") as f:
    countries = json.load(f)

# Altair åœ°å›¾æ•°æ®æ ¼å¼
country_geo = alt.Data(values=countries["features"])

# å¯é€‰æŒ‡æ ‡
indicators = ["BMI", "Diabetes_Crude", "Diabetes_AgeStd", 
              "Hypertension_Prevalence", "Hypertension_Control", "Hypertension_Treatment"]

# åˆå§‹é€‰æ‹©æ§ä»¶
year_selector = alt.binding_range(min=data["year"].min(), max=data["year"].max(), step=1, name="Year:")
gender_selector = alt.binding_select(options=data["Gender"].unique().tolist(), name="Gender:")
indicator_selector = alt.binding_select(options=indicators, name="Indicator:")

year_sel = alt.selection_single(fields=["year"], bind=year_selector, init={"year": 2000})
gender_sel = alt.selection_single(fields=["Gender"], bind=gender_selector, init={"Gender": "Both"})
indicator_sel = alt.selection_single(fields=["indicator"], bind=indicator_selector, init={"indicator": "BMI"})

# é‡å¡‘æ•°æ®æ–¹ä¾¿ melt
melted = data.melt(
    id_vars=["location", "region", "year", "Gender", "risk_level", "health_status"],
    value_vars=indicators,
    var_name="indicator",
    value_name="value"
)

# ç»‘å®š selection çš„è¿‡æ»¤æ•°æ®
filtered = melted

# åˆ›å»ºåœ°å›¾å›¾è¡¨
map_chart = alt.Chart(country_geo).mark_geoshape(
    stroke="white"
).encode(
    color=alt.Color("value:Q", scale=alt.Scale(scheme="orangered"), title="Value"),
    tooltip=[
        alt.Tooltip("location:N", title="Country Code"),
        alt.Tooltip("indicator:N", title="Indicator"),
        alt.Tooltip("value:Q", format=".2f"),
        alt.Tooltip("health_status:N")
    ]
).transform_lookup(
    lookup="properties.ISO_A3",
    from_=alt.LookupData(filtered, "location", ["value", "indicator", "health_status"])
).project(
    type="mercator"
).add_selection(
    year_sel, gender_sel, indicator_sel
).transform_filter(
    year_sel & gender_sel & indicator_sel
).properties(
    width=800,
    height=450,
    title="å…¨çƒå„å›½å¥åº·æŒ‡æ ‡åœ°å›¾"
)

map_chart
```