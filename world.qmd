---
title: "å…¨çƒæ…¢æ€§ç—…æŒ‡æ ‡åœ°å›¾ï¼ˆé™æ€åˆå§‹å›¾ï¼‰"
format:
  html
jupyter: python3
---

## ğŸŒ å…¨çƒ BMI æŒ‡æ ‡åœ°å›¾ï¼ˆé™æ€ç‰ˆï¼‰

æœ¬å›¾å±•ç¤ºäº† 2000 å¹´åœ¨å„å›½ `Both` æ€§åˆ«ä¸‹çš„å¹³å‡ BMI æ°´å¹³åˆ†å¸ƒæƒ…å†µã€‚

```{python}
import pandas as pd
import altair as alt
from vega_datasets import data
import pycountry

# è¯»å–æ•°æ®
df = pd.read_csv("data/processed-data/who_combined_data.csv")

# è¿‡æ»¤æ•°æ®
filtered = df[
    (df["year"] == 2022) &
    (df["indicator_name"] == "BMI â‰¥ 30") &
    (df["Gender"] == "Both sexes")
].copy()

# å°† Alpha-3 å›½å®¶ä»£ç è½¬æ¢ä¸º ISO æ•°å­—ä»£ç ï¼ˆåŒ¹é… Altair åœ°å›¾ï¼‰
def alpha3_to_numeric(alpha3):
    try:
        return int(pycountry.countries.get(alpha_3=alpha3).numeric)
    except:
        return None

filtered["id"] = filtered["country_code"].apply(alpha3_to_numeric)

# åŠ è½½åœ°å›¾æ•°æ®
countries = alt.topo_feature(data.world_110m.url, "countries")

# ç”»å›¾
chart = alt.Chart(countries).mark_geoshape(
    stroke='white'
).encode(
    color=alt.Color("value:Q", scale=alt.Scale(scheme="orangered"), title="BMI â‰¥ 30 (%)"),
    tooltip=[
        alt.Tooltip("country:N", title="Country"),
        alt.Tooltip("value:Q", title="BMI â‰¥ 30 (%)", format=".2f")
    ]
).transform_lookup(
    lookup="id",
    from_=alt.LookupData(filtered, "id", ["country", "value"])
).project(
    type="equalEarth"
).properties(
    width=800,
    height=400,
    title="2022å¹´å…¨çƒ BMI â‰¥ 30 çš„åˆ†å¸ƒï¼ˆBoth Sexesï¼‰"
)

chart

```


```{python}
import pandas as pd
import altair as alt
from vega_datasets import data
import pycountry

# è¯»å–æ•°æ®
df = pd.read_csv("data/processed-data/who_combined_data.csv")

# ç­›é€‰ 2022 å¹´ã€Both sexesã€ä¸‰ä¸ª BMI æŒ‡æ ‡
filtered = df[
    (df["year"] == 2022) &
    (df["Gender"] == "Both sexes") &
    (df["indicator_name"].isin(["BMI < 18.5", "BMI â‰¥ 25", "BMI â‰¥ 30"]))
].copy()

# å°† alpha-3 å›½å®¶ç è½¬æ¢ä¸ºæ•°å­—ç ä»¥åŒ¹é…åœ°å›¾
def alpha3_to_numeric(alpha3):
    try:
        return int(pycountry.countries.get(alpha_3=alpha3).numeric)
    except:
        return None

filtered["id"] = filtered["country_code"].apply(alpha3_to_numeric)
filtered = filtered[filtered["id"].notna()]

# åŠ è½½ä¸–ç•Œåœ°å›¾
countries = alt.topo_feature(data.world_110m.url, "countries")

# å®šä¹‰ç”»å›¾å‡½æ•°
def make_bmi_map(indicator_label, color_scheme):
    df_sub = filtered[filtered["indicator_name"] == indicator_label]

    return alt.Chart(countries).mark_geoshape(
        stroke='white'
    ).encode(
        color=alt.Color("value:Q", title="Prevalence (%)", scale=alt.Scale(scheme=color_scheme)),
        tooltip=[
            alt.Tooltip("country:N", title="å›½å®¶"),
            alt.Tooltip("value:Q", title=indicator_label, format=".2f")
        ]
    ).transform_lookup(
        lookup="id",
        from_=alt.LookupData(df_sub, "id", ["country", "value"])
    ).project(
        type="equalEarth"
    ).properties(
        width=800,
        height=300,
        title=f"{indicator_label}ï¼ˆ2022, Both Sexesï¼‰"
    )

# åˆ†åˆ«åˆ›å»ºä¸‰å¼ åœ°å›¾
# ä¸‰å¼ å›¾åˆ†åˆ«åŠ ä¸Š .resolve_scale(color='independent')
chart1 = make_bmi_map("BMI < 18.5", "blues").resolve_scale(color='independent')
chart2 = make_bmi_map("BMI â‰¥ 25", "greens").resolve_scale(color='independent')
chart3 = make_bmi_map("BMI â‰¥ 30", "orangered").resolve_scale(color='independent')

# æ‹¼æ¥æˆç«–å›¾
final_chart = alt.vconcat(chart1, chart2, chart3)


final_chart

```

```{python}
import pandas as pd
import altair as alt
from vega_datasets import data
import pycountry

# è¯»å–æ•°æ®
df = pd.read_csv("data/processed-data/who_combined_data.csv")

# åªä¿ç•™ 2022ã€Both sexes
filtered = df[
    (df["year"] == 2022) & (df["Gender"] == "Both sexes")
].copy()

# æ·»åŠ  numeric country IDï¼ˆåœ°å›¾ lookup ç”¨ï¼‰
def alpha3_to_numeric(alpha3):
    try:
        return int(pycountry.countries.get(alpha_3=alpha3).numeric)
    except:
        return None

filtered["id"] = filtered["country_code"].apply(alpha3_to_numeric)

# è¯»å–åœ°å›¾
world_map = alt.topo_feature(data.world_110m.url, "countries")

```

```{python}
# ä¸åœ¨å›¾å†…éƒ¨è°ƒç”¨ configure_viewï¼Œä¹Ÿä¸è¦ resolve_scale æ”¾åœ¨å›¾é‡Œ
def draw_bmi_map(indicator_label, color_scheme):
    df_sub = filtered[filtered["indicator_name"] == indicator_label].copy()
    
    chart = alt.Chart(world_map).mark_geoshape(
        stroke='white'
    ).encode(
        color=alt.Color("value:Q", title=indicator_label + " (%)", scale=alt.Scale(scheme=color_scheme)),
        tooltip=[
            alt.Tooltip("country:N", title="Country"),
            alt.Tooltip("value:Q", title="Prevalence", format=".2f")
        ]
    ).transform_lookup(
        lookup="id",
        from_=alt.LookupData(df_sub, "id", ["country", "value"])
    ).project(
        type="equalEarth"
    ).properties(
        width=700,
        height=300,
        title=f"{indicator_label} ï¼ˆ2022, Both Sexesï¼‰"
    )
    
    return chart

# åˆ†åˆ«åˆ›å»ºå›¾
bmi_under = draw_bmi_map("BMI < 18.5", "blues")
bmi_over = draw_bmi_map("BMI â‰¥ 25", "greens")
bmi_obese = draw_bmi_map("BMI â‰¥ 30", "oranges")

# æ‹¼æ¥ï¼Œå¹¶ç»Ÿä¸€è®¾ç½® config
final = alt.vconcat(bmi_under, bmi_over, bmi_obese).configure_view(
    stroke=None
).resolve_scale(
    color='independent'  # æ¯å¼ å›¾ç”¨ç‹¬ç«‹çš„é¢œè‰²æ¯”ä¾‹
)

final

```